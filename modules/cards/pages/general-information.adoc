= Общие сведения

.Вместе с платформой разработчик получает два уровня API:
* Базовый API -- универсальное средство программного доступа ко всем функциям платформы {dv}. Может быть использован в проектах, основанных на .NET (сборка `DocsVision.Platform.ObjectManager.dll`) и COM (сборка `ObjectManager.dll`) технологиях.
* Высокоуровневый слой, объектная модель {dv} (далее -- "объектная модель") -- набор базовых объектов и функциональных возможностей, с помощью которых могут быть реализованы специализированные модели сущностей выбранной предметной области.
+
Использование готовых базовых типов позволяет снизить издержки на разработку собственного решения, обеспечит прозрачность архитектуры, простоту расширения и интеграции нескольких решений, включая _{bo}_ (являются частью платформы Docsvision). API данного уровня является удобным средством для работы с карточками. Сборки данного уровня API имеют только .NET-версию.

В зависимости от применимости функциональных возможностей выбранного уровня API, можно выделить четыре группы задач разработчика:

. Задачи, при решении которых могут быть задействованы как базовый API, так и объектная модель.
+
Это, например, с некоторыми ограничениями, доступ к данным карточек.
+
. Задачи, которые эффективнее решать с использованием методов объектной модели.
+
Одной из таких задач является запуск задания на исполнение.
+
. Задачи, которые могут быть решены только методами базового API.
+
Например: поиск данных по секции карточки.
+
. Задачи, которые не могут быть решены с помощью API Docsvision.

Если при решении определённой задачи потребуется задействовать методы обоих уровней API нужно помнить, что каждый слой обладает собственным механизмом кэширования, что может повлиять на актуальность данных на одном слое по сравнению с другим.

В примерах использования API, рассмотренных в разделе xref:ROOT:development.adoc[Руководство по разработке], если это возможно, одна задача будет решена как методами базового API, так и методами объектной модели, что позволит оценить удобство и функциональные возможности разных уровней при решении конкретной задачи.

Далее приведена информация относительно некоторых ключевых объектов и терминов API {dv}, которые необходимы для понимания последующих примеров разработки.

[#session-context]
== Пользовательская сессия и контекст объектов

В API {dv} существуют две ключевые сущности, представляющие функциональные возможности своего слоя API: _пользовательская сессия_ (или сессия пользователя) и _контекст объектов_.

Пользовательская сессия::
Пользовательская сессия является главным объектом в базовом API и обеспечивает единую точку доступа к остальным функциям данного API.
+
С физической точки зрения, сессия -- контекст сеанса связи с сервером для конкретного пользователя. Сессия ассоциируется с доменной учетной записью, от имени которой установлено соединение, и в дальнейшем все привилегии на доступ к данным из этой сессии проверяются относительно этой учетной записи.
+
В рамках сессии кэшируются все данные, к которым производилось обращение, для ускорения последующего доступа к ним. Размер кэша и продолжительность пребывания в нём данных автоматически регулируются платформой, на основании внутренних алгоритмов. Разработчик может только явно потребовать удаления конкретных объектов из кэша (при помощи методов этих объектов).
+
Создание сессии является первоочередной задачей при разработке любых внешних (относительно платформы) приложений, работающих с {dv}. При разработке внутрисистемных объектов, таких как скрипты карточек (в _Конструкторе скриптов_ или _Конструкторе разметок_) или бизнес-процессы, готовая сессия передается при инициализации.

Контекст объектов::
_Контекст объектов_ -- элемент объектной модели, который обеспечивает загрузку и сохранение данных карточек. _Контекст объектов_ также предоставляет доступ к функциям, реализующим основную бизнес-логику для работы с бизнес-объектами. Функциональные возможности контекста объектов обеспечивают инициализацию объектной модели карточки при загрузке её данных из базы данных, а также последующее связывание данных.
+
_Контекст объектов_ должен быть проинициализирован, чтобы работать с объектной моделью карточки. Исключением являются разработка скриптов карточек и бизнес-процессов -- в этих случаях готовый _контекст объектов_ будет доступен из базового класса (для скрипта карточки) и из параметров вызванного метода (для бизнес-процесса).
+
Для инициализации _контекста объектов_ потребуется _пользовательская сессия_.

[#managers]
== Менеджеры базового API

_Менеджеры_ -- сущности базового API, в которых собраны методы для работы с различными объектами платформы.

.Например, есть менеджеры для работы с карточками, файлами, безопасностью и прочие:
* `xref:Platform-ObjectManager-AccessManager:AccessManager_CL.adoc[AccessManager]` -- менеджер объектов безопасности, в котором представлены методы управления правами доступа на объекты системы, а также методы для работы с крипто-объектами.
* `xref:Platform-ObjectManager-CardManager:CardManager_CL.adoc[CardManager]` -- менеджер карточек. Данный менеджер предоставляет полный набор средств для работы с экземплярами карточек: создание, получение и удаление.
* `xref:Platform-ObjectManager-Extension:ExtensionManager_CL.adoc[ExtensionManager]` -- менеджер расширений. Данный менеджер предоставляет единственный метод `GetExtensionMethod`, возвращающий метод серверного расширения.
* `xref:Platform-ObjectManager-ILockable:FileManager_CL.adoc[FileManager]` -- менеджер файлов, предоставляющий методы для работы с файлами: создание, получение и удаление, а также некоторые другие.
* `xref:Platform-ObjectManager-Lock:LicenseManager_CL.adoc[LicenseManager]` -- менеджер лицензий. Данный менеджер предоставляет два метода для учета числа подключений в лицензии дополнительного модуля.
* `xref:Platform-ObjectManager-Lock:LockManager_CL.adoc[LockManager]` -- менеджер блокировок. Предоставляет методы получения объектов xref:card-lock.adoc[блокировки] с объекта системы. Для полнофункциональной работы могут потребоваться права администратора.
* `xref:Platform-ObjectManager-LogManager:LogManager_CL.adoc[LogManager]` -- менеджер журнала. Данный менеджер содержит операции для работы с системным журналом.
* `xref:Platform-ObjectManager-Report:ReportManager_CL.adoc[ReportManager]` -- менеджер хранимых процедур. Предоставляет метод для получения данных хранимой процедуры.

Чтобы получить доступ к интересующему _менеджеру_, необходимо обратиться к соответствующему свойству сущности xref:general-information.adoc#session-context[пользовательской сессии]:

[source,csharp]
----
CardManager cardManager = userSession.CardManager;
----

[#services]
== Сервисы объектной модели

На уровне объектной модели {dv} принято выносить бизнес-логику из объектной модели карточки в отдельные _сервисы_, доступ к которым можно получить непосредственно из _контекста объектов_. _Сервисы_ выполняют задачи, аналогичные тем, что выполняют _менеджеры_ базового API, но со специализацией на конкретных типах карточек -- есть сервисы для работы с документами, с заданиями, со справочниками и т.п.

На программном уровне, _сервис_ -- это пара, состоящая из интерфейса, определяющего функциональные возможности _сервиса_, и класса, реализующего данный интерфейс.

В базовой поставке {dv} предоставляются системные сервисы (для работы с блокировками, доступом и т.п.), а также сервисы для работы с карточками библиотеки карточек _{bo}_. Полный список сервисов приведён далее.

.Полный список сервисов
[cols=",,",options="header"]
|===
|Область действия |Сервис |Назначение

.7+|Общего назначения
|`xref:BackOffice-ObjectModel-Services:IAccessCheckingService_IN.adoc[IAccessCheckingService]`
|Определяет функции получения списка ролей и доступных операций сотрудника в пределах заданной карточки. Предоставляет методы сброса кэша ролевой модели.

|`xref:BackOffice-ObjectModel-Services-IBaseCardService:IBaseCardService_IN.adoc[IBaseCardService]`
|Предоставляет методы установки и проверки ЭП, генерации дайджеста и управления бизнес-процессом.

|`xref:BackOffice-ObjectModel-Services-ILockService:ILockService_IN.adoc[ILockService]`
|Позволяет управлять состоянием блокировки объектов, получать информацию о текущем состоянии и владельце блокировки.

|`xref:BackOffice-ObjectModel-Services-ILockService:ILogService_IN.adoc[ILogService]`
|Определяет методы добавления и получения записей журнала карточки.

|`xref:BackOffice-ObjectModel-Services-I:IServerExtensionProxyService_IN.adoc[IServerExtensionProxyService]`
|Позволяет выполнять методы серверного расширения BackOffice.

|`xref:BackOffice-ObjectModel-Services-I:ISettingsCardService_IN.adoc[ISettingsCardService]`
|Предоставляет методы доступа к системным настройкам.

|`xref:BackOffice-ObjectModel-Services-ICryptService:ICryptService_IN.adoc[ICryptService]`
|Сервис шифрования файлов карточек приложения _{bo}_

.13+|Карточки
|`xref:BackOffice-ObjectModel-Services-IDocumentService:IDocumentService_IN.adoc[IDocumentService]`
|Предназначен для работы с карточками типа _Документ_

|`xref:BackOffice-ObjectModel-Services-IBarcodeService:IBarcodeService_IN.adoc[IBarcodeService]`
|Определяет методы генерации и печати штрих-кодов карточки документа.

|`xref:BackOffice-ObjectModel-Services-ITaskService:ITaskService_IN.adoc[ITaskService]`
|Предназначен для работы с карточками типа _Задание_

|`xref:BackOffice-ObjectModel-Services-ITaskGroupService:ITaskGroupService_IN.adoc[ITaskGroupService]`
|Предназначен для работы с карточками типа _Группа заданий_

|`xref:BackOffice-ObjectModel-Services-ITaskListService:ITaskListService_IN.adoc[ITaskListService]`
|Предназначен для работы с карточками типа _Список ссылок на карточки заданий_

|`xref:BackOffice-ObjectModel-Services-ICategoryListService:ICategoryListService_IN.adoc[ICategoryListService]`
|Предназначен для работы с карточками типа _Список категорий_

|`xref:BackOffice-ObjectModel-Services-INumerationRulesService:INumeratorCardService_IN.adoc[INumeratorCardService]`
|Предназначен для работы с карточками типа _Карточка нумератора_

|`xref:BackOffice-ObjectModel-Services-INumerationRulesService:INumerationRulesService_IN.adoc[INumerationRulesService]`
|Предназначен для работы с карточками типа _Конструктор правил нумерации_

|`xref:BackOffice-ObjectModel-Services-IReferenceListService:IReferenceListService_IN.adoc[IReferenceListService]`
|Предназначен для работы с карточками типа _Список ссылок на карточки_

|`xref:BackOffice-ObjectModel-Services-ICategoriesService:ICalendarService_IN.adoc[ICalendarService]`
|Предназначен для работы с карточками типа _Бизнес-календарь_

|`xref:BackOffice-ObjectModel-Services-IVersionedFileCardService:IVersionedFileCardService_IN.adoc[IVersionedFileCardService]`
|Предназначен для работы с карточками типа _Карточка файла с версиями_

|`xref:BackOffice-ObjectModel-Services-IStateService:ISurveyService_IN.adoc[ISurveyService]`
|Предназначен для работы с карточками типа _Список опросов_

|`xref:BackOffice-ObjectModel-Services-IVersionedFileCardService:IUserProfileCardService_IN.adoc[IUserProfileCardService]`
|Предназначен для работы с карточками типа _Карточка настроек пользователя_

.5+|Конструкторы
|`xref:BackOffice-ObjectModel-Services-I:IRoleModelService_IN.adoc[IRoleModelService]`
|Конструктор ролей

|`xref:BackOffice-ObjectModel-Services-IBaseUniversalService:IBaseUniversalService_IN.adoc[IBaseUniversalService]`
|Карточка строки справочника

|`xref:BackOffice-ObjectModel-Services-ILinkService:ILayoutService_IN.adoc[ILayoutService]`
|Конструктор разметок

|`xref:BackOffice-ObjectModel-Services-I:IScriptingService_IN.adoc[IScriptingService]`
|Конструктор скриптов

|`xref:BackOffice-ObjectModel-Services-IStateService:IStateService_IN.adoc[IStateService]`
|Конструктор состояний

.8+|Справочники
|`xref:BackOffice-ObjectModel-Services-ICategoriesService:ICategoriesService_IN.adoc[ICategoriesService]`
|Справочник категорий

|`xref:BackOffice-ObjectModel-Services-IKindService:IKindService_IN.adoc[IKindService]`
|Справочник видов карточек

|`xref:BackOffice-ObjectModel-Services-I:ISettingsService_IN.adoc[ISettingsService]`
|Предоставляет методы для работы с настройками расширений справочника видов.

|`xref:BackOffice-ObjectModel-Services-IStaffService:IStaffService_IN.adoc[IStaffService]`
|Справочник сотрудников

|`xref:BackOffice-ObjectModel-Services-IPartnersService:IPartnersService_IN.adoc[IPartnersService]`
|Справочник контрагентов

|`xref:BackOffice-ObjectModel-Services-I:IServersService_IN.adoc[IServersService]`
|Справочник серверов

|`xref:BackOffice-ObjectModel-Services-I:ISignatureLabelService_IN.adoc[ISignatureLabelService]`
|Справочник меток подписей

|`xref:BackOffice-ObjectModel-Services-ILinkService:ILinkService_IN.adoc[ILinkService]`
|Справочник ссылок
|===

Чтобы получить один из _сервисов_, необходимо использовать метод `GetService` _контекста объектов_, уточнив тип (публичный интерфейс) запрашиваемого сервиса:

[source,csharp]
----
IDocumentService documentService = objectContext.GetService<IDocumentService>(); <.> <.>
----
<.> `objectContext` -- сущность xref:general-information.adoc#session-context[контекста объектов].
<.> `IDocumentService` -- интерфейс, реализуемый _сервисом_.

[#mappers]
== Преобразователи данных

В объектной модели {dv} карточки представляются в виде сущностей конкретной предметной области, к примеру: задания, документы, книги и т.п. Каждый тип таких сущностей обладает, как правило, собственной объектной моделью, которая определённым образом связана с данными карточки.

Чтобы определить механизм этого связывания, реализуется специальный класс -- _преобразовать данных_,- в котором определяется связь между элементом карточки и свойством объектной модели, представляющим данный элемент.

При получении объекта из _контекста объектов_, данные карточки автоматически загружаются в объектную модель карточки, а при сохранении данных выполняется обратная операция. Для работы данного механизма соответствующий преобразователь данных должен быть загружен в _контекст объектов_.

В базовую поставку {dv} входят _преобразователи данных_, которые необходимы для работы с объектной моделью карточек библиотеки _{bo}_. Для работы с объектной моделью собственных типов карточек, разработчику предлагается реализовать собственный _преобразователь данных_.

[#objects]
== Объекты хранения данных

Ключевым объектом {dv}, соответствующим сущностям целевой системы, является _карточка_. С карточками работают как пользователи, так и разработчики. Если для пользователя карточка -- это прежде всего графический интерфейс, на который определённым образом выведены данные, то для разработчика -- это объектная модель, метаданные и сами данные.

Прежде чем перейти к дальнейшему описанию необходимо дать определения нескольким ключевым понятиям:

* _Тип карточки_ -- описание сущности целевой системы в {dv}.
+
Если проводить аналогию с программированием, то тип карточки -- это класс.
+
[NOTE]
====
В {dv} представлено xref:schemas:ROOT:index.adoc[большое количество] типов карточек. Если существующие типы недостаточно точно отражают объект целевой системы, может быть разработан xref:solutions:cards/scheme/dev-cards-and-lib.adoc[собственный] с уникальной бизнес-логикой.
====
+
* _Экземпляр карточки_ -- экземпляр карточки определённого типа. Экземпляр карточки обладает уникальным идентификатором, по которому карточка может быть получена из базы данных. Если следовать аналогии, то экземпляр карточки -- это объект.
* _Поле_ -- элемент структуры карточки, предназначенный для непосредственного хранения данных определённого типа. Также может ссылаться на другие элементы данной или другой карточки.
* _Секция_ -- элемент структуры карточки, объединяющий группу полей.
+
С точки зрения метаданных, карточка -- это набор _секций_ с коллекциями _полей_. Каждая секция карточки обладает собственным набором полей, что обеспечивает необходимый уровень гибкости для реализации структур хранения данных.
+
[NOTE]
====
На уровне базы данных секция -- это таблица, а поле -- это столбец данной таблицы.
====

Конкретный набор секций и полей, а также их характеристики определяет _схема карточки_. Каждый тип карточек обладает собственной схемой, что позволяет реализовать в системе объекты, приближенные по характеристикам к сущностям выбранной предметной области. К примеру, для хранения информации о книгах библиотеки, может быть реализована карточка типа `Книга` с полями: название, автор, дата издания и т.п. Для хранения информации о входящих документах компании можно реализовать карточку типа `Входящий документ` с полями: отправитель, дата отправки, специалист, который должен получить данный документ.

На уровне экземпляра карточки (конкретного документа, задания и т.п.) наборы данных хранятся не просто в полях секций карточки, а в _строках_ секций -- полях подчиненных по отношению к секциям сущностях. Строки обеспечивают возможность хранения в одной секции коллекции наборов данных, в т.ч. с определённой иерархией.

Это может быть востребовано, к примеру, если в карточке типа `Книга` должны храниться сведения о нескольких авторах этой книги. Помимо табличного варианта организации строк секции, предусмотрена иерархическая структура, при которой строка секции может содержать подчиненные строки из этой же секции. Такая структура секции обычно используется в справочниках -- карточки, представленные в единственном экземпляре (ограничение устанавливается схемой карточки), данные из которых используются в других карточках. Примером справочника может служить _Справочник сотрудников_ из библиотеки карточек _{bo}_, данные которого используются во многих других типах карточек данной библиотеки.

.Структура секции определяются её типом:
* Плоская секция -- может содержать только одну строку. Создание второй строки будет воспринято как ошибка.
* Коллекционная секция -- может содержать набор строк. Секция данного типа по сути аналогична обычной таблице.
* Иерархическая секция -- может содержать иерархию строк, в которой строка может иметь в подчинении строки этой же секции.

[NOTE]
====
На уровне базы данных секция строка секции -- это строка таблицы, а секция -- сама таблица.
====

Далее, для обобщения изложенной выше информации, представлена структура экземпляра карточки некого типа. Подобную структуру можно составить на основе данных, предоставляемых программой "Docsvision Explorer" из комплекта "{rk}".

.Структура экземпляра карточки
image::ROOT:card-sample-structure.png[Структура экземпляра карточки]

.Приведенную карточку (в сочетании со схемой типа карточки) можно охарактеризовать следующим образом:
* Карточка содержит две секции: Секция "A" (иерархическая) и Секция "B" (плоская).
* Секция "A" содержит две строки: Строка 1 и Строка 2. У Строки 1 есть подчиненная строка -- Подстрока 1. В секции определено два поля: Поле 1 и Поле 2.
* Секция "B" содержит единственную строку (Строка 1), что определено ограничениями плоской секции. В секции определены поля: Поле 1, Поле 2 и Поле 3.
* Секция "B" также имеет подчиненную секцию -- Подсекция "С" (коллекционная), которая содержит две строки: Строка 1 и Строка 2. В секции определено единственное поле -- Поле 1.

Для представления данных карточки в API {dv} реализовано несколько классов, специфичных для выбранного уровня (слоя) API. Далее приведены такие типы для обоих уровней API Docsvision.

[#base-api-objects]
=== Объекты хранения данных на уровне базового API

Типы, приведенные далее, определены в сборке `DocsVision.Platform.ObjectManager.dll`.

* `xref:Platform-ObjectManager-CardData:CardData_CL.adoc[CardData]` -- данные экземпляра карточки. Включает совокупность всех данных секций и атрибутов конкретного экземпляра карточки.
* `xref:Platform-ObjectManager-SectionData:SectionData_CL.adoc[SectionData]` -- данные секции карточки, из которой может быть получена коллекция всех её строк.
* `xref:Platform-ObjectManager-Row:RowDataCollection_CL.adoc[RowDataCollection]` -- коллекция строк секции, из которой могут быть выбраны конкретные строки.
+
[NOTE]
====
Если коллекция получена непосредственно из карточки, то она считается "живой", т.е. при создании/удалении строки изменения в коллекции будут видны сразу же. Если коллекция получена поисковым запросом, она является "моментальным снимком" данных, доступным только на чтение.
====
+
* `xref:Platform-ObjectManager-Row:RowData_CL.adoc[RowData]` -- строка секции. Выбрать строку из коллекции строк можно по уникальному идентификатору, по номеру в коллекции либо перебором.
* `xref:Platform-ObjectManager-SubsectionData:SubSectionData_CL.adoc[SubSectionData]` -- подмножество строк (подсекция) секции, подчинённых определённой строке из родительской секции.
* `xref:Platform-ObjectManager-Metadata:Field_CL.adoc[Field]` -- поле строки секции, а точнее его значение.

.Обычный сценарий доступа к данным карточки с привлечением приведенных типов следующий:
. Получить экземпляр карточки -- `CardData`.
. Получить нужную секцию из карточки: `CardData.Sections[Section_ID]`.
. Получить коллекцию строк выбранной секции: `SectionData.Rows`.
. Выбрать конкретную строку из секции: `SectionData.Rows[Row_ID]`.
. Получить значение поля по псевдониму: `RowData[FieldAlias]`.

[#storage-objects]
=== Объекты хранения данных на уровне объектной модели

Типы, приведенные далее, определены в сборках: `DocsVision.BackOffice.ObjectModel.dll` -- содержит типы, описывающие сущности карточки и `DocsVision.Platform.ObjectModel.dll` -- содержит общие базовые классы.

[WARNING]
====
Приведенные далее сведения относятся только к карточкам, объектная модель которых унаследована от базового класса `xref:BackOffice-ObjectModel-BaseCard:BaseCard_CL.adoc[BaseCard]`. Если объектная модель создана на основе базовых классов из сборки `DocsVision.Platform.ObjectModel.dll`, механизм доступа к данным будет отличаться.
====

.Объектная модель карточки предлагает гораздо меньшее (в сравнении с базовым API) число типов:
* BaseCard -- базовый класс карточки, который содержит коллекции всех строк её секций.
* `xref:BackOffice-ObjectModel-BaseCard:BaseCardSectionRow_CL.adoc[BaseCardSectionRow]` -- строка секции, предоставляющая доступ к своим полям.

Как видно из списка, в объектной модели нет отдельных классов для секций и полей, что упрощает сценарий доступа к данным, который в общем случае будет следующий:

. Получить экземпляр карточки -- тип `BaseCard`, либо унаследованный от него.
. Выбрать строки конкретной секции, воспользовавшись методом `BaseCard.GetSection`.
. Выбрать строку из полученной коллекции.
. Получить значение нужного поля по его псевдониму: `BaseCardSectionRow["FieldAlias"]`.

.Если для типа карточки была реализована собственная объектная модель, то обращение к данным карточки будут выглядеть ещё проще:
. Получить экземпляр карточки, к примеру, типа `SampleCard` -- унаследован от типа `BaseCard`.
. Получить коллекцию строк секции, из соответствующего публичного свойства класса: `SampleCard.SampleSection`.
. Выбрать нужную строку секции: `SampleCard.SampleSection[0]`. Если секция является плоской и это учтено при реализации объектной модели, то данный шаг пропускается.
. Получить значение поля: `SampleCard.SampleSection[0].SampleField`.

Помимо типов, приведенных выше и относящихся к доступу к данным карточки, в процессе разработки типов могут быть задействованы дополнительные типы, к примеру, относящиеся к справочникам. Если такие типы будут использованы далее, будет приведено их описание. Также описание большинства типов API {dv} приведено в разделе xref:DocsVisionObjectModel:class-lib.adoc[Библиотека классов].
